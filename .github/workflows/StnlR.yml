name: StnlR üõ∞

on:
  workflow_dispatch:
  schedule:
    # Runs once every 24 hours (00:30 UTC = 06:00 IST)
    - cron: "30 0 * * *"

concurrency:
  group: stnlr-radio
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üéß Build StnlR.m3u (AUDIO ONLY ‚Äì NORMALIZED)
        shell: bash
        env:
          TZ: "Asia/Kolkata"
        run: |
          set -euxo pipefail

          tmpdir=$(mktemp -d)
          trap 'rm -rf "$tmpdir"' EXIT

          timestamp=$(date +"%Y-%m-%d %H:%M:%S %Z")
          mkdir -p Pawn
          out_file="Pawn/StnlR.m3u"

          SRC_URL="https://rjmbts.github.io/Souloc/Mazes/StnlR.m3u"

          echo "üåê Fetching source:"
          echo "$SRC_URL"

          if ! curl -fsSL --max-time 60 "$SRC_URL" > "$tmpdir/raw.m3u"; then
            echo "‚ùå Failed to fetch source"
            exit 1
          fi

          echo "üéß Normalizing Tamil Radio entries..."

          awk '
          BEGIN { RS="#EXTINF"; }
          NR>1 {
            block = "#EXTINF" $0
            n = split(block, lines, "\n")

            ext = lines[1]
            url = ""

            # Extract station name (after last comma)
            name = ext
            sub(/^.*?,[ \t]*/, "", name)
            gsub(/[ \t\r]+$/, "", name)

            # Extract tvg-logo if present
            logo = ""
            if (match(ext, /tvg-logo="[^"]*"/)) {
              logo = substr(ext, RSTART+10, RLENGTH-11)
            }

            # Find first valid URL
            for (i = 2; i <= n; i++) {
              gsub(/^[ \t\r]+|[ \t\r]+$/, "", lines[i])
              if (lines[i] ~ /^https?:\/\//) {
                url = lines[i]
                break
              }
            }

            if (url == "" || name == "") next

            # Deduplicate by URL
            if (seen[url]++) next

            print "#EXTINF:1 tvg-type=\"radio\" radio=\"true\" group-title=\"Tamil | Radio\" tvg-logo=\"" logo "\", " name
            print url
          }
          ' "$tmpdir/raw.m3u" > "$tmpdir/radio_unique.m3u"

          total=$(grep -c '^#EXTINF' "$tmpdir/radio_unique.m3u" || echo 0)

          if [ "$total" -eq 0 ]; then
            echo "‚ùå No radio streams found after processing"
            exit 1
          fi

          {
            echo '#EXTM3U billed-msg="RJM Radio - RJMBTS Network"'
            echo "# Pushed & Updated by ‚Äî Kittujk"
            echo "# Coded & Maintained by @RJMBTS"
            echo "# Last updated on : $timestamp"
            echo "# Tamil Radio Streams : $total"
            echo ""
          } > "$out_file"

          cat "$tmpdir/radio_unique.m3u" >> "$out_file"

          echo "‚úÖ Pawn/StnlR.m3u generated"
          echo "üéß Total Tamil radio streams: $total"

      - name: üöÄ Commit & Push StnlR.m3u
        shell: bash
        run: |
          set -euxo pipefail

          git config user.name "RJMBTS Auto Builder"
          git config user.email "actions@github.com"

          git add Pawn/StnlR.m3u || true

          if git diff --cached --quiet; then
            echo "No changes ‚Äî skipping commit."
          else
            git commit -m "üéß Auto-update Pawn/StnlR.m3u (Tamil Radio)"
            git pull --rebase origin main || git rebase --abort
            git push origin main || echo "‚ö†Ô∏è Push failed"
          fi
